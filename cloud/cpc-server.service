[Unit]
Description=Run a Copernicus Server
Requires=etcd2.service
After=etcd2.service

[Service]
SyslogIdentifier=%p
ExecStartPre=/usr/bin/docker pull soellman/gromacs
ExecStartPre=/usr/bin/docker pull soellman/copernicus
ExecStartPre=-/usr/bin/docker create --name gromacs soellman/gromacs /bin/true
ExecStartPre=-/usr/bin/mkdir /home/core/copernicus
ExecStartPre=-/usr/bin/chown 1000 /home/core/copernicus
ExecStartPre=-/usr/bin/docker rm -f %p
ExecStart=/usr/bin/docker run --rm --name %p \
  --volumes-from gromacs \
  -p 13807:13807 \
  -p 14807:14807 \
  -v /home/core/copernicus:/home/copernicus \
  -e COPERNICUS_PASSWORD=${PASSWORD} \
  soellman/copernicus
# stash the connection bundle into etcd
ExecStartPost=/bin/bash -c \
  'CFG=/home/core/copernicus/.copernicus/client.cnx ; \
   until [ -e $CFG ] ; do sleep 1 ; done ; \
   IP=$(ifconfig eth0 | grep "inet " | awk -F"[ ]+" "{ print \\$3 }") ; \
   cat $CFG | \
   sed "s|\\(\\"client_host\\": \\"\\)\\(.*\\)\\"|\\1$IP\\"|" | \
   etcdctl set /cpc/server'
ExecStop=/usr/bin/docker stop %p
SuccessExitStatus=1 137
